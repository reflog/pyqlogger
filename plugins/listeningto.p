## $Id: listeningto.p 32 2004-12-06 13:57:09Z reflog $
## This file is part of PyQLogger.
##
## Copyright (c) 2004 Eli Yukelzon a.k.a Reflog
##                    Xander Soldaat a.k.a. Mightor
## PyQLogger is free software; you can redistribute it and/or modify
## it under the terms of the GNU General Public License as published by
## the Free Software Foundation; either version 2 of the License, or
## (at your option) any later version.
##
## PyQLogger is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
##
## You should have received a copy of the GNU General Public License
## along with PyQLogger; if not, write to the Free Software
## Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA


import ToolBarManager
from qt import QMessageBox

class Listeningto_Plugin(ToolBarManager.ToolbarPlugin):
    tooltip = "Insert currently playing song artist and title"
    xmms = None

    image = \
        "\x89\x50\x4e\x47\x0d\x0a\x1a\x0a\x00\x00\x00\x0d" \
        "\x49\x48\x44\x52\x00\x00\x00\x20\x00\x00\x00\x20" \
        "\x08\x06\x00\x00\x00\x73\x7a\x7a\xf4\x00\x00\x05" \
        "\xea\x49\x44\x41\x54\x28\x91\xbd\xd7\x4b\x6c\x5c" \
        "\x57\x1d\xc7\xf1\xef\xb9\x2f\xdf\x3b\xd7\x73\xe7" \
        "\xe1\xe7\x8c\xc7\x8e\x6b\xe7\x65\x3b\xb5\x71\xd3" \
        "\x24\x52\x48\x5a\xa4\x50\x09\x89\x10\x44\x17\xc0" \
        "\xa6\x12\x0f\xd1\x45\x57\x08\x75\xc5\xa2\xa2\xea" \
        "\x8a\x05\x88\x65\x11\x02\xb1\x80\x22\xa1\x52\x81" \
        "\xaa\x26\xa1\xaa\xc4\xa2\x08\xa9\x75\x5c\xb5\x4e" \
        "\x62\x82\x93\x3a\x7e\x24\xc4\xe3\xf8\x31\xe3\x79" \
        "\xdc\xf7\x3d\x2c\x1c\xa4\xc8\x69\xda\xa1\x36\xf9" \
        "\xad\x8f\xee\xff\xa3\x7b\x74\xfe\xe7\x7f\x90\x52" \
        "\xb2\x33\x39\x83\xe3\xe7\x46\xac\x57\xb3\x82\xaf" \
        "\x02\x5d\x80\x78\x60\xd1\x1e\x44\x4a\x89\x90\x52" \
        "\x22\xc4\x03\xdf\x2f\xfc\xf4\xeb\xbd\x97\x8b\x5d" \
        "\x6a\xc7\x8d\xdb\x41\xf9\xc6\x8a\xff\xd1\xf2\x86" \
        "\x37\xb7\x5a\x0b\x96\xe3\x84\x8d\x86\x4f\x6d\xcb" \
        "\xa5\x09\x78\x12\x22\xc0\x4f\xa0\xe1\x42\x0d\xa8" \
        "\x02\x4d\xc0\xdd\x0d\x80\xe7\x8e\x3a\x6f\xbf\xf0" \
        "\x0d\xe7\x19\xcd\x48\xa8\xd7\x05\x41\xa8\x21\x15" \
        "\x93\x04\x95\x10\x0d\xda\x0c\x62\x34\x92\x20\x94" \
        "\x51\x18\x49\xaf\xe1\x47\xae\xeb\xc5\x5b\x9b\x41" \
        "\xb3\x5c\xf1\x6e\x2f\x94\xfd\x1b\xd7\xcb\xee\xa5" \
        "\x6b\x6b\xc9\xdf\x42\xb8\x0c\x34\x3e\x09\xa0\x3d" \
        "\x4c\x37\x77\xc7\x9b\xbe\xbb\xea\x3c\xd3\x37\x00" \
        "\xe9\x74\x82\x69\x0b\xac\x6e\x9b\x54\x3e\x8b\x95" \
        "\x75\xb0\x3b\x73\x68\xf9\x0c\x78\xa1\x68\x6e\x6c" \
        "\x0a\x77\x63\xcb\xf0\xaa\x0d\xfc\x6a\xcd\xaa\xad" \
        "\x6e\x75\x34\x37\x1b\xe3\x71\x64\x3d\xbb\x70\x27" \
        "\x4e\x66\xe6\xe5\xc7\x17\x3f\xac\xfc\xf6\xf2\x1a" \
        "\x3f\x03\xfc\xfb\xeb\x28\x0f\x03\x2c\x6e\x06\x97" \
        "\xca\x1b\x09\x51\x0c\x71\x22\x88\xa4\x0a\x8a\x8a" \
        "\x9e\xb2\xd1\x33\x0e\x5a\xc6\x01\x3b\x0f\x8e\x8d" \
        "\x66\x9a\xa8\x9a\x86\xa2\x40\x92\xc4\x28\x22\xa6" \
        "\x3d\x1d\x32\x30\xe8\x71\xf6\xcb\x0d\xe5\xc7\xdf" \
        "\x6f\x1c\x78\xfe\x4c\xe7\x4f\x80\x53\x3b\xeb\x3c" \
        "\x14\xb0\xe2\x72\xa9\x5c\x49\xaa\x41\x00\xaa\x02" \
        "\x8a\x10\xc8\x28\x21\x6c\xba\x04\xb5\x06\x61\xad" \
        "\x01\x8d\x0a\x72\xab\x41\x14\x84\xc4\x52\x92\x24" \
        "\x00\x82\x28\x49\x40\x26\x40\x82\xa6\x07\x64\x0b" \
        "\x21\x87\x87\x3c\xbd\xd7\xe4\x74\xcb\x00\x60\x71" \
        "\x7a\xbe\xf6\x96\xd7\x14\x08\x15\x84\xae\xa1\xd9" \
        "\x16\x6d\x4e\x3b\x6d\x4e\x1a\x3d\x9f\x03\x3b\x0d" \
        "\x40\xe8\xfa\x84\xf5\x26\x91\xe7\x11\x7a\x21\x32" \
        "\x4e\x40\x40\x9c\x28\xf8\x81\x06\x02\xc6\x0e\x36" \
        "\x39\xd0\x63\x9d\x00\xcc\x56\x01\x4c\x2f\x34\xde" \
        "\xae\x6e\x81\x10\x02\x01\x24\x41\x44\xe0\x7a\x84" \
        "\x4d\x17\x02\x1f\x90\x08\x55\x41\x6b\xd3\x51\xda" \
        "\x0c\x84\xa6\xa2\xa8\xdb\x9f\x54\xd4\x04\xd3\x88" \
        "\x31\xcd\x08\x02\xe8\xec\x4c\x98\x1c\x32\x26\x80" \
        "\x7d\x2d\x03\x6e\x35\x99\x5a\x2e\xc7\x1e\x28\xb4" \
        "\xa5\x74\x4c\x27\x85\x99\x69\xc7\xca\xa6\x41\x37" \
        "\xa0\xbe\x85\xbb\x59\x23\xdc\x6a\x10\xd6\x9a\x44" \
        "\x9e\x4f\x14\x04\x90\xc4\xdb\x7f\x26\xba\xb7\x13" \
        "\x06\xe8\x45\xf8\xe2\x58\x5c\x10\x30\xd1\x32\x20" \
        "\x81\x9b\x0b\xe5\xe0\xe3\x9b\xf3\x92\xca\x5a\x48" \
        "\xe4\x05\x88\x24\x42\x37\x55\x48\x39\xd0\xde\x81" \
        "\x95\x6f\xc7\xc8\xd8\x18\x69\x13\xcd\x34\x10\x8a" \
        "\x00\x24\x9a\x9a\x60\x9a\x31\x42\x01\xe9\x01\x3e" \
        "\x1c\x1a\x8c\x19\x74\xc4\xc9\xfb\x6b\x3c\xf4\x18" \
        "\xde\x8b\xbb\x5c\xf5\xae\x34\x1b\xa9\xb1\x3f\x9f" \
        "\x5f\x77\x3b\x72\x75\xed\xd0\x48\x4d\xef\x29\xac" \
        "\x91\xed\xbb\x8d\x9d\x31\x11\x44\x10\xf9\xf8\x8d" \
        "\x3a\x41\xcd\x45\x06\x31\xaa\x90\xe8\x3a\xe8\x2a" \
        "\xa4\x4c\x10\x69\xc0\x84\xf1\x51\x97\xf1\x92\x75" \
        "\xec\xe6\xac\x9b\x05\x2a\xad\x00\x58\xde\x08\x66" \
        "\x07\x7a\x55\x5e\xfb\x47\x6d\xe6\xc2\x5f\xef\xfe" \
        "\xbc\xdb\xb8\x35\xd2\x69\x33\xdc\x97\x6f\xeb\xcf" \
        "\x67\xcc\x9e\x9e\x8c\x9e\x4f\x9b\x4a\xbb\x63\x69" \
        "\x96\x69\x2a\x8a\xa5\x81\x6d\x0a\x7a\xf3\x26\xd5" \
        "\x3c\x14\x8b\x92\x1e\x25\x04\x01\xc2\x81\x93\xa3" \
        "\xfa\xd8\x5f\x66\xdd\x61\x60\xba\x35\xc0\x5a\x74" \
        "\xa5\x52\x8f\x39\x52\x32\xfb\x2f\x5c\xf3\xa6\x56" \
        "\x03\xfe\xb8\x1a\x20\x66\x37\xfd\x76\xf0\x33\x40" \
        "\x16\x48\x03\x8e\x80\x5c\x0a\xba\x1c\x8b\x9e\xac" \
        "\x29\xfa\xfb\x3b\xcd\xc7\x46\x8a\xf6\xc1\xd1\x01" \
        "\xba\x9f\x18\xf3\xc5\x93\xc7\x5c\x4e\x4f\xfa\x99" \
        "\xd4\xeb\x1c\x6b\xde\x03\xf0\x49\x97\xd1\x8e\x1c" \
        "\xf8\xcd\x77\x0a\xfe\xaf\xbf\x5b\x90\xc0\xd9\xcf" \
        "\x5a\xbc\x23\x0e\x30\x02\x9c\x1b\x6c\x57\x7e\xf1" \
        "\xc2\x29\xfb\xc6\xf9\x1f\x76\xca\x13\x25\xfd\xf7" \
        "\xb0\x7d\x0d\xb4\x02\xb0\x5f\x3e\xd7\xf1\xaf\xf3" \
        "\x2f\x16\x65\xc1\xe2\xa5\xff\x11\xb0\x33\xa5\x52" \
        "\x8a\x97\x9e\x1e\x34\xce\x03\xa5\x56\x01\x7c\x6b" \
        "\xd2\xfa\xd3\xd4\x2b\x45\x79\x72\x40\x7b\x9d\x16" \
        "\xb6\xad\x85\x0c\x00\x59\x29\xe5\xa7\x1f\xc3\xff" \
        "\x66\xa1\x1c\xcd\x2a\x6a\xc2\xe1\xbe\xb6\x11\xa0" \
        "\x67\x0f\x00\x4b\xdc\x3b\x05\x2d\x01\x96\x37\xc2" \
        "\xab\xd5\x7a\xc4\xe4\x90\x3e\xc4\x8e\x4e\xb6\xdb" \
        "\xb4\x04\x58\xf1\x98\xb9\xb3\x11\x05\xc3\x7d\xc2" \
        "\x4c\xed\xe8\x64\x8f\x04\x90\xc0\xd2\x62\x99\x5b" \
        "\xfd\xdd\x09\x03\x79\x31\xc1\x1e\x8e\x68\x2d\x01" \
        "\x80\xfa\xec\x52\x38\xeb\xa4\x23\x0e\x17\x8c\x71" \
        "\xa0\xf7\x51\x03\xb8\x5e\x0e\xaf\xc4\xb1\x64\x72" \
        "\xbf\xb6\x1f\x18\x7e\xe4\x80\xe5\xf5\xe0\xea\x7a" \
        "\x05\x4e\x8c\x88\x2e\x47\x3c\x38\xd9\xfc\xdf\x01" \
        "\x77\x5d\x66\x96\xca\x22\x18\x2e\x85\x8c\x97\xac" \
        "\xa7\xd9\x31\x58\x7c\xde\xdc\xdf\x54\x3a\x8e\x16" \
        "\xc4\xb7\x07\x73\xda\xe9\x74\x4a\xeb\x52\x54\x12" \
        "\x2f\x64\x6b\xa9\xec\xce\x5f\x2d\xf3\xee\x66\xc4" \
        "\xe5\x6b\x8b\xe2\xf6\xe9\xe3\xfe\x63\x87\x7a\xb3" \
        "\x87\xff\xbe\xec\x16\x81\xf9\xbd\x02\xf4\xfd\xe8" \
        "\xa9\xdc\x5b\x67\xcf\xf4\x4f\x1c\xfd\xda\x57\x70" \
        "\x8a\x05\x00\x64\x14\xe1\x6e\x6e\x72\x6d\xea\xa3" \
        "\x17\x2f\xbe\xf9\xde\xa2\xdf\x94\x76\x1c\xd5\x79" \
        "\x7c\x88\x12\x53\x0c\xed\x19\x60\xbc\x4b\xf9\xe6" \
        "\x99\x2f\xe8\x13\xc3\x8f\x67\x71\xc6\x9e\x04\xa3" \
        "\x08\xe8\x08\x54\x52\x7d\x0a\x4f\x1c\x39\xc3\xf0" \
        "\xe8\x6b\xfb\xde\x7b\xf3\x1d\xde\x7d\x3f\x26\x93" \
        "\x52\xb5\x4e\x83\xc9\xb5\x80\x77\xf6\x04\xb0\x5a" \
        "\x4d\xfe\x1d\x91\xa0\x37\xa7\xb9\xfe\x87\x97\xd1" \
        "\xf2\xfb\x49\xe5\xba\x50\x74\x13\x90\xc8\x24\xc2" \
        "\xaf\xd6\x28\x0d\x18\xd8\xa6\xc6\xdc\x9c\x49\x29" \
        "\xaf\x4c\xac\xad\x24\xdb\xe3\xcf\x6e\x01\x2b\x01" \
        "\x6f\xbc\x7a\xb1\xf1\x46\x47\xce\x78\xf6\xc0\xfe" \
        "\x7f\xe2\xaf\xcf\x53\xb9\x6d\x13\x25\x06\x52\x6e" \
        "\xf7\x1c\x19\x27\x98\x86\xcb\xc4\x91\x3a\x19\xdb" \
        "\x64\xdf\x54\x6a\xec\xc3\x95\x7a\x37\x50\xde\x35" \
        "\x00\x08\x2f\xcc\xb9\xcf\xaf\xfd\x2a\xae\x7f\xef" \
        "\x4b\xb9\xe7\x8e\x4f\xf8\xa2\xa7\xbb\x82\x69\xc5" \
        "\xe8\xba\x44\xd3\x40\x53\x40\x51\xc1\x0f\x61\x75" \
        "\xd5\x20\x96\xbe\x02\xe8\xbb\x29\x0e\x3c\xf0\x36" \
        "\xd4\x15\x38\x7b\x6a\x9f\xf5\x83\x53\x07\x53\x4f" \
        "\xf5\x77\x0b\xbb\xbb\x23\x24\xeb\x04\x68\x86\xa4" \
        "\xd1\xd0\x98\x5f\xb4\x78\x7f\x2e\x5c\xfd\xdd\x07" \
        "\x95\x57\x12\xf8\x25\x10\x7e\xde\xe2\x9f\xf6\x38" \
        "\xb5\x80\x51\x13\xc6\xdb\xa0\x10\xb3\xbd\xd1\x1a" \
        "\x28\x0d\x58\x8f\xe0\x03\x60\x86\x16\x5e\xc0\x9f" \
        "\x05\xf8\x0f\xbd\x53\x93\x3b\x27\x84\x0f\x77\x00" \
        "\x00\x00\x00\x49\x45\x4e\x44\xae\x42\x60\x82"


    def available(self,idx):
        import commands
        if(idx == 1):
            try:
                import xmms.control
                if xmms.is_running():
		    self.xmms = xmms.control 
		    return True
            except:
                pass
            return False
        elif(idx == 2):
            out = commands.getoutput('dcop noatun')
            return out and not  ( ("failed" in out) or ("No such application" in out))
        elif(idx == 3):
            out = commands.getoutput('dcop amarok')
            return out and not  ( ("failed" in out) or ("No such application" in out))
            
    def getTitle(self,idx):
        import commands
        if(idx == 1):
            current_index = self.xmms.get_playlist_pos()
            current_title = self.xmms.get_playlist_title(current_index)                
            return current_title
        elif(idx == 2):
            return commands.getoutput('dcop noatun Noatun title')
        elif(idx == 3):
            return commands.getoutput('dcop amarok player title')
        
        
    def on_click(self):
        pos = self.parent.sender().cursor().pos()-self.parent.pos()+QPoint(32,32)
        ec = ei = 0
        for i in range(1,4):
            if self.available(i):
                ec += 1
                ei = i
        if ec == 1:
            self.Popup(ei)
        elif (ec == 0):
            QMessageBox.warning(None,
            self.parent.trUtf8("Error"),
            self.parent.trUtf8("""No players detected!"""))           
        else:
            self.Menu.popup(pos)

    def UpdateMenu(self):        
        for i in range(1,4):
            self.Menu.setItemEnabled(i,self.available(i))

    def Popup(self,idx):
        current_title = self.getTitle(idx)
        if current_title:
            sourceEditor = self.parent.sourceEditor
            line, index = sourceEditor.getCursorPosition()
            sourceEditor.insertAt("Currently listening to: %s\n" % \
            unicode(current_title), line, index)
        else:
            QMessageBox.warning(None,
            self.parent.trUtf8("Error"),
            self.parent.trUtf8("""No songs loaded in playlist."""))            

    def getWidget(self):
        page = self.parent.getPage("Plugins")
        button = QPushButton(page)
        bi = QPixmap()
        bi.loadFromData(self.image,"PNG")
        self.Menu = QPopupMenu()
        self.Menu.insertItem("XMMS",1)
        self.Menu.insertItem("Noatun",2)
        self.Menu.insertItem("Amarok",3)
        self.parent.connect(self.Menu,SIGNAL("activated(int)"),self.Popup)  
        self.parent.connect(self.Menu,SIGNAL( "aboutToShow()"),self.UpdateMenu)
        #button.setPopup(self.Menu)          
        button.setIconSet(QIconSet(bi))
        w = 32
        h = 32
        button.setMaximumSize(QSize(w,h))
        QToolTip.add(button,self.tooltip)
        self.parent.connect(button,SIGNAL("clicked()"),self.on_click)
        button.show()
        self.button = button
